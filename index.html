<html>
<head>
<title>Elise Colbert (emc277), Jacob Gleberman (jhg279), Quinn Halpin (qmh4)</title>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<style>
	svg { border: solid #ccc 1px; }
	body { font-family: 'Alegreya Sans', Calibri, sans-serif; }
	.words {width : 700px;}
</style>
</head>
<body>
<div>
	<select id = "dataset">
	</select><br>
	<select id = "selector_1">
	</select><br>
	<select id = "selector_2">
	</select><br>
	<select id = "selector_3">
	</select><br>
	<select id = "special_selector">
	</select>
	<button id="see_tree">See Tree</button>
	<p id = "ball_animation"></p>
</div>
<script type = "text/javascript" src = "animation.js"></script>
<script type="text/javascript">
	var student_math = [];
	var student_por = [];
	var student_int = [];
	var tree_arr = [];
	var paths;
	function parseRow(row) {
		// filter out name of person and entries that have no base pay
		if (Math.round(Number(row.base_pay)) != 0.){
			employee_object = row;
			delete employee_object["employee_name"];
			delete employee_object["notes"];
			employee_object["job_category"] = findCluster(row.job_title);
			return employee_object;
		}
	}

	function parseStudentRow(row) {
		// change all string numbers to numbers
		// yes = 1
		// no = 0
		// some options are not listed here because parsing them wasn't necessary
		row.Dalc = Number(row.Dalc);
		row.Fedu = Number(row.Fedu);
		row.G1 = Number(row.G1);
		row.G2 = Number(row.G2);
		row.G3 = Number(row.G3);
		row.Medu = Number(row.Medu);
		row.Walc = Number(row.Walc);
		row.absences = Number(row.absences);
		row.activities = (row.activities == "yes") ? 1: 0;

		row.age = Number(row.age);
		row.failures = Number(row.failures);
		row.famrel = Number(row.famrel);
		row.famsup = (row.famsup == "yes") ? 1 : 0;
		row.higher = (row.higher == "yes") ? 1: 0;
		row.internet = (row.internet == "yes") ? 1: 0;
		row.nursery = (row.nursery == "yes") ? 1: 0;
		row.romantic = (row.romantic == "yes") ? 1: 0;
		row.schoolsup = (row.schoolsup == "yes") ? 1: 0;
		
		row.freetime = Number(row.freetime);
		row.goout = Number(row.goout);
		row.health = Number(row.health);
		row.studytime = Number(row.studytime);
		row.traveltime = Number(row.traveltime);
		return row;
	}

	function parseInternationalStudents(row) {
		row.gender = (row.gender == "Male") ? 1 : 0;
		row.StudentAbsenceDays = (row.StudentAbsenceDays == "Above-7") ? 1: 0;
		row.ParentschoolSatisfaction = (row.ParentschoolSatisfaction == "Good") ? 1: 0;
	}

 	d3.queue()
        .defer(d3.csv, "student_grades/student-mat.csv", parseStudentRow)
        .defer(d3.csv, "student_grades/student-por.csv", parseStudentRow)
        .defer(d3.csv, "xAPI-Edu-Data.csv", parseInternationalStudents)
        .defer(d3.csv, "Speed-Dating-Data.csv")
        .await(load_data);
    
    function createTreePath(svg, tree_arr){
    	var path_arr = [];
    	var pathGenerator = d3.line()
			.x(function(d){return (d.x)})
			.y(function(d){return (d.y)});	
    	for (var i = 0; i < tree_arr.length; i++){
    		var p = d3.path();
    		p.moveTo(tree_arr[i][0]["x1"],tree_arr[i][0]["y1"])
    		var path_data = [];
    		for (var j = 0; j<tree_arr[i].length-1; j++){
    			p.lineTo( tree_arr[i][j]["x2"], tree_arr[i][j]["y2"]);
    			p.lineTo( tree_arr[i][j+1]["x1"], tree_arr[i][j+1]["y1"]);
    		}
			p.lineTo(tree_arr[i][tree_arr[i].length-1]["x2"], tree_arr[i][tree_arr[i].length-1]["y2"]);
    		p = p.toString();
    		svg_path= svg.append("path").attr("d", p).style("stroke-width", 2)
    		.attr("id", "path_" + i)
            .style("stroke", "steelblue")
            .style("stroke-width", "5px")
            .style("fill", "none")
            .style("opacity", 0);

            path_arr.push(svg_path);
    	}
    	return path_arr;
    }

    var data_dict = {};

    function normalize(dataset, chosen_functions, special_funct){
    	//given a dataset, determine how many people are in a category and normalize
    	//determine number of people in each category
    	category = [];

    	// dataset.forEach(function(p){

    	// })

    	for (var i= 0;i < Math.pow(2,chosen_functions.length); i++){
    		category.push({"num_units": 0, "per_yes_special":0});
    	}
    	//special param is an array by category index and holds % yes for that category
    	normalized_dataset = {"ball_data": [], "special_param": []};
    	num_options = Math.pow(2,chosen_functions.length) - 1; 
    	dataset.forEach(function(p){
    		var cat_ind = chosen_functions.reduce(function (acc,fun, ind){ 
    			//determine category of each unit in dataset
    			return acc - Math.pow(2,chosen_functions.length - 1 - ind)*fun(p);
    		}, num_options);
    		//add to the number of people in this category
    		category[cat_ind].num_units += 1;
    		//add to the number of yes people for this category
    		category[cat_ind].per_yes_special += (special_funct(p)) ? 1 : 0;
    	})
    	console.log(category)
    	category.forEach(function(category_value, cat_ind){
    		//define percent of yes according to special function for this category
    		num_people = category[cat_ind]["num_units"];
    		category[cat_ind]["per_yes_special"] = (num_people > 0) ? 
    			Math.round(100*(category[cat_ind]["per_yes_special"]/num_people)) : 0;
    		//define percent of people in this category
    		category[cat_ind]["num_units"] = Math.round(100*(num_people/dataset.length));
    	})

    	for (var j = 0; j < category.length; j++){
    		//for each category add a ball for each percent in that category
			for (var k = 0; k < category[j]["num_units"]; k++){
				normalized_dataset["ball_data"].push(j);	
    		}
    	}

    	d3.shuffle(normalized_dataset["ball_data"])
    	normalized_dataset["special_param"] = category.map(x=> x.per_yes_special);
    	return normalized_dataset;
    }

 	function load_data(error, math, portugal, international, speeddating){
 		student_math = math;
 		student_por = portugal;
 		student_int = international;
 		var ball_svg_height = 600;
		var ball_svg_width = 1000;
		
		var ball_svg = d3.select("#ball_animation").append("svg")
		.attr("height", ball_svg_height)
		.attr("width", ball_svg_width);

		databases = {};
		databases["High school student data in Portugal"] = "math";
		databases["International students data"] = "int";
		databases["Speed dating in Colombia"] = "dating";

		function hasInternet(person){
			return person.internet;
		}
		function hasRomance(person){
			return person.romantic;
		}
		function isHigher(person){
			return person.higher;
		}
		function hasNursery(person){
			return person.nursery;
		}
		function hasActivities(person){
			return person.activities;
		}
		function parentsApart(person){
			return person.Pstatus == "A";
		}
		function liveInCity(person){
			return person.address == "U";
		}

		data_dict["math"] = [hasInternet, hasRomance, isHigher, hasNursery, hasActivities, parentsApart, liveInCity];

		//INTERNATIONAL DATA
		function isMale(person){
			return person.gender;
		}
		function manyAbsences(person){
			return person.StudentAbsenceDays;
		}
		function parentsSatisfied(person){
			return person.ParentschoolSatisfaction;
		}
		function highGrades(person){
			return person.Class == "H";
		}
		function lowGrades(person){
			return person.Class == "L";
		}

		data_dict["int"] = [isMale, manyAbsences, parentsSatisfied, highGrades, lowGrades];

		//SPEEDDATING
		function isMaleDate(person){
			return person.gender;
		}
		function valuesRace(person){
			return person.imprace >= 6;
		}
		function valuesReligion(person){
			return person.impreligion >=6;
		}
		function datesFrequently(person){
			//if a person goes on dates more than once a month
			return person.date <=5;
		}

		data_dict["dating"] = [isMaleDate, valuesRace, valuesReligion, datesFrequently];
		
		var curr_hue = 1;
		d3.select("#see_grades").on("click", function() {see_grades(ball_svg)});
		d3.select("#user_input").append("text").style("font", "17px times")
		.text("Speed");

		var questions_data_math = {
			"Does the student do extracurriculars?": [hasActivities, "Extracurriculars"],
			"Does the student live in urban environment?": [liveInCity, "Urban Area"],
			"Does the student have internet?": [hasInternet, "Internet"],
			"Is the student in a romantic relationship?": [hasRomance, "Romance"],
			"Did the student go to higher education?": [isHigher, "Higer Education"],
			"Did the student go to nursery school?": [hasNursery, "Nursery"],
			"Do the parents live apart?": [parentsApart, "Parents Apart"]
			}

		var questions_data_int ={
			"Is the student male?": [isMale, "Male"],
			"Does the student have more than 7 absences?": [manyAbsences, "Many absences"],
			"Are the student's parents satisfied with their school?": [parentsSatisfied, "Parents satisfied"],
			"Does the student get high grades?": [highGrades, "High grades"],
			"Does the student get low grades?": [lowGrades, "Low grades"]
		}

		var questions_data_date = {
			"Is the subject male?": [isMaleDate, "Male"],
			"Does the participant prefer a partner who is the same race as them?": [valuesRace, "Values same race"],
			"Does the participant prefer a partner who is the same religion as them?": [valuesReligion, "Values same religion"],
			"Does the participant date more than once a month?": [datesFrequently, "Dates more than once a month"]
		}

		//TEMPORARY
		questions_data = questions_data_math;

		function add_selector_values(selector_arr, questions, questions_ind){
			//adds values to selectors
			if (selector_arr.length <=0) return;
			var selector = selector_arr[0]
			selector.on("change", function(x){})
				.selectAll("option").data(questions).enter().append("option")
				.text(d=>d)
			selector.select("options").attr("defaultSelected",true);
			var head = questions.shift()
			questions.push(head)
			selector_arr.shift()
			add_selector_values(selector_arr, questions, questions_ind + 1)
		}

		var selector_1 = d3.select("#selector_1");
		var selector_2 = d3.select("#selector_2");
		var selector_3 = d3.select("#selector_3");
		var special_selector = d3.select("#special_selector");
		var select_dataset = d3.select("#dataset");

		var all_selectors = [selector_1, selector_2, selector_3]
		var temp_arr_selectors = [selector_1, selector_2, selector_3, special_selector];
		var temp_questions_data = questions_data;
		var temp_dataset_questions = databases;
		var temp_dataset_selectors = [select_dataset];
		add_selector_values(temp_arr_selectors, Object.keys(temp_questions_data), 0)
		add_selector_values(temp_dataset_selectors, Object.keys(temp_dataset_questions), 0)
		
		d3.select("#see_tree").on("click", see_tree);
		var created_tree = false;
		var paths;
		function see_tree(){
			factor_obj ={"factor_arr": [], "questions_arr":[], "shortened_arr": []};
			var funct, shorten_q, question;
			all_selectors.forEach(function(selector){
				question = selector.property("value");
				factor_obj["factor_arr"].push(questions_data[question][0]);
				factor_obj["questions_arr"].push(question);
				factor_obj["shortened_arr"].push(questions_data[question][1]);
			})
			special_fun = questions_data[special_selector.property("value")][0];
			special_short_quest = questions_data[special_selector.property("value")][1];
			var tree_root = {"x": 305, "y": 70};
			var splits = Math.pow(2, factor_obj["factor_arr"].length)
			var normalized_dataset = normalize(student_math,factor_obj["factor_arr"], special_fun);
			if (created_tree == false){
				tree_arr = createTreeBegin(ball_svg, tree_root, 200, 200, splits);
				paths = createTreePath(ball_svg, tree_arr);
			}
			spoutBalls(ball_svg, ball_svg_height, ball_svg_width, tree_arr, tree_root,normalized_dataset, factor_obj, paths);
			// spoutBalls(ball_svg, ball_svg_height, ball_svg_width, tree_arr, tree_root,student_math, factor_obj, paths);
 			addStrings(ball_svg_height, ball_svg_width, tree_arr, ball_svg, factor_obj["questions_arr"]);		
			created_tree = true
		}

		
 		
 	}	
</script>
</body>