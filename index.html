<html>
<head>
<title>Decision Tree</title>
<!-- <title>Elise Colbert (emc277), Jacob Gleberman (jhg279), Quinn Halpin (qmh4)</title> -->
<link rel="stylesheet" type="text/css" href="style.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<style>

</style>
</head>
<body>

	
</div><div id = "container">
    <div id = "text_for_scroll">
        <div id='sections'>
    <section class = "tool_bar">
            <div class = "title">Data Selection</div>
            <div id = "selector_div">
		Pick Dataset:<br>
		<div class="styled-select semi-square">
			<select id = "dataset">
			</select>
		</div><br><br>
			First Boolean Variable:<br>
		<div class="styled-select semi-square">
			<select id = "selector_1">
			</select>
		</div><br><br>
			Second Boolean Variable:<br>
		<div class="styled-select semi-square">	
			<select id = "selector_2">
			</select>
		</div><br><br>
			Third Boolean Variable<br>
		<div class="styled-select semi-square">	
			<select id = "selector_3">
			</select>
		</div><br><br>
		<button id="see_tree_button">See Tree</button>
		<input type ="checkbox" id="skip_animation">Skip Animation</button>
		<br><br>
   </section>
      <section class="step">
        <div class="title">Step</div>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam lobortis, eros sit amet pellentesque consectetur, enim sapien tincidunt ante, a finibus elit libero non ex. Suspendisse potenti.
      </section>
      <section class="step">
        <div class="title">Step</div>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam lobortis, eros sit amet pellentesque consectetur, enim sapien tincidunt ante, a finibus elit libero non ex. Suspendisse potenti.
      </section>
      <section class="step">
        <div class="title">Step</div>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam lobortis, eros sit amet pellentesque consectetur, enim sapien tincidunt ante, a finibus elit libero non ex. Suspendisse potenti.
      </section>
      <section class="step">
        <div class="title">Step</div>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam lobortis, eros sit amet pellentesque consectetur, enim sapien tincidunt ante, a finibus elit libero non ex. Suspendisse potenti.
      </section>
      <section class="step">
        <div class="title">Step</div>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam lobortis, eros sit amet pellentesque consectetur, enim sapien tincidunt ante, a finibus elit libero non ex. Suspendisse potenti.
      </section>
      <section class="step">
        <div class="title">Step</div>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam lobortis, eros sit amet pellentesque consectetur, enim sapien tincidunt ante, a finibus elit libero non ex. Suspendisse potenti.
      </section>
      <section class="step">
        <div class="title">Step</div>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam lobortis, eros sit amet pellentesque consectetur, enim sapien tincidunt ante, a finibus elit libero non ex. Suspendisse potenti.
      </section>
      <section class="step">
        <div class="title">Step</div>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam lobortis, eros sit amet pellentesque consectetur, enim sapien tincidunt ante, a finibus elit libero non ex. Suspendisse potenti.
      </section>
      <section class="step">
        <div class="title">Step</div>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam lobortis, eros sit amet pellentesque consectetur, enim sapien tincidunt ante, a finibus elit libero non ex. Suspendisse potenti.
      </section>
    </div>
	</div>
	<div id = "ball_animation"></div>

	<div id = "text_for_scroll">
	</div>
</div> 
</div>
<script type = "text/javascript" src = "animation.js"></script>
<script type = "text/javascript" src = "scroll.js"></script>
<script type = "text/javascript" src = "graph-scroll.js"></script>

<script type="text/javascript">
	var student_math = [];
	var student_por = [];
	var student_int = [];
	var tree_arr = [];
	var paths;
	var ball_svg_width;
	var ball_svg_height;
	var called_see_tree;
	function parseRow(row) {
		// filter out name of person and entries that have no base pay
		if (Math.round(Number(row.base_pay)) != 0.){
			employee_object = row;
			delete employee_object["employee_name"];
			delete employee_object["notes"];
			employee_object["job_category"] = findCluster(row.job_title);
			return employee_object;
		}
	}



	function parseStudentRow(row) {
		// change all string numbers to numbers
		// yes = 1
		// no = 0
		// some options are not listed here because parsing them wasn't necessary
		row.Dalc = Number(row.Dalc);
		row.Fedu = Number(row.Fedu);
		row.G1 = Number(row.G1);
		row.G2 = Number(row.G2);
		row.G3 = Number(row.G3);
		row.Medu = Number(row.Medu);
		row.Walc = Number(row.Walc);
		row.absences = Number(row.absences);
		row.activities = (row.activities == "yes") ? 1: 0;

		row.age = Number(row.age);
		row.failures = Number(row.failures);
		row.famrel = Number(row.famrel);
		row.famsup = (row.famsup == "yes") ? 1 : 0;
		row.higher = (row.higher == "yes") ? 1: 0;
		row.internet = (row.internet == "yes") ? 1: 0;
		row.nursery = (row.nursery == "yes") ? 1: 0;
		row.romantic = (row.romantic == "yes") ? 1: 0;
		row.schoolsup = (row.schoolsup == "yes") ? 1: 0;
		
		row.freetime = Number(row.freetime);
		row.goout = Number(row.goout);
		row.health = Number(row.health);
		row.studytime = Number(row.studytime);
		row.traveltime = Number(row.traveltime);
		return row;
	}

	function parseInternationalStudents(row) {
		row.gender = (row.gender=="M") ? 1:0;
		row.StudentAbsenceDays = (row.StudentAbsenceDays == "Above-7") ? 1: 0;
		row.ParentschoolSatisfaction = row.ParentschoolSatisfaction== "Good" ? 1: 0;
		return row;
	}

 	d3.queue()
        .defer(d3.csv, "student_grades/student-mat.csv", parseStudentRow)
        .defer(d3.csv, "student_grades/student-por.csv", parseStudentRow)
        .defer(d3.csv, "xAPI-Edu-Data.csv", parseInternationalStudents)
        .defer(d3.csv, "Speed-Dating-Data.csv")
        .await(load_data);
    
    function createTreePath(svg, tree_arr){
    	var path_arr = [];
    	var pathGenerator = d3.line()
			.x(function(d){return (d.x)})
			.y(function(d){return (d.y)});	
    	for (var i = 0; i < tree_arr.length; i++){
    		var p = d3.path();
    		p.moveTo(tree_arr[i][0]["x1"],tree_arr[i][0]["y1"])
    		var path_data = [];
    		for (var j = 0; j<tree_arr[i].length-1; j++){
    			p.lineTo( tree_arr[i][j]["x2"], tree_arr[i][j]["y2"]);
    			p.lineTo( tree_arr[i][j+1]["x1"], tree_arr[i][j+1]["y1"]);
    		}
			p.lineTo(tree_arr[i][tree_arr[i].length-1]["x2"], tree_arr[i][tree_arr[i].length-1]["y2"]);
    		p = p.toString();
    		svg_path= svg.append("path").attr("d", p).style("stroke-width", 2)
    		.attr("id", "path_" + i)
            .style("stroke", "steelblue")
            .style("stroke-width", "5px")
            .style("fill", "none")
            .style("opacity", 0);

            path_arr.push(svg_path);
    	}
    	return path_arr;
    }

    var data_dict = {};

    function determineCategory(chosen_functions, p){
    	//given the functions and the data point p determine category
    	num_options = Math.pow(2,chosen_functions.length) - 1; 
    	cat_ind = chosen_functions.reduce(function (acc,fun, ind){ 
    			//determine category of each unit in dataset
    			return acc - Math.pow(2,chosen_functions.length - 1 - ind)*fun(p);
    	}, num_options);
    	return cat_ind;
    }

    function normalize(dataset, chosen_functions){
    	//given a dataset, determine how many people are in a category and normalize
    	//determine number of people in each category
    	category = [];
    	color = d3.scaleOrdinal(d3.schemeCategory10);
    	for (var i= 0;i < Math.pow(2,chosen_functions.length); i++){
    		category.push({"num_units": 0, "per_yes_special":0, "final_num": 0, "color": color(i)});
    	}
    	
    	//special param is an array by category index and holds % yes for that category
    	normalized_dataset = {"ball_data": [], "special_param": []};
    	dataset.forEach(function(p){
    		// //console.log(chosen_functions)
    		var cat_ind = determineCategory(chosen_functions, p);
    		// //console.log(p)
    		// //console.log("in dataset finder")
    		// //console.log(cat_ind)
    		//add to the number of people in this category
    		category[cat_ind].num_units += 1;
    	})
    	category.forEach(function(category_value, cat_ind){
    		//define percent of yes according to special function for this category
    		num_people = category[cat_ind]["num_units"];
    		category[cat_ind]["per_yes_special"] = (num_people > 0) ? 
    			Math.round(100*(category[cat_ind]["per_yes_special"]/num_people)) : 0;
    		//define percent of people in this category
    		category[cat_ind]["num_units"] = Math.round(100*(num_people/dataset.length));
    		category[cat_ind]["final_num"] = category[cat_ind]["num_units"];
    	})

    	for (var j = 0; j < category.length; j++){
    		//for each category add a ball for each percent in that category
			for (var k = 0; k < category[j]["num_units"]; k++){
				normalized_dataset["ball_data"].push(j);	
    		}
    	}
    	//make a global variable [function_data_arr] that stores for each boolean
    	//function the percent of people who evaluate to true;
    	function_data_arr = chosen_functions.map(f=>{ 
    		acc = 0;
    		for (var k = 0; k < dataset.length; k++){
    			acc += f(dataset[k])
    		}
    		yes_val = Math.round(100*acc/dataset.length);
    		return [yes_val, 100-yes_val]; 
    	})

    	normalized_dataset["special_param"] = category.map(x=> x.per_yes_special);
    	make_large_pie(category);
    	return normalized_dataset;
    	
    }

 	function load_data(error, math, portugal, international, speeddating){
 		student_math = math;
 		student_por = portugal;
 		student_int = international;
 		speed_dating = speeddating;
 		ball_svg_height = 600;
		ball_svg_width = 800;
		
		ball_svg = d3.select("#ball_animation").append("svg")
		.attr("height", ball_svg_height)
		.attr("width", ball_svg_width);
		find_dataset = {"High school student data in Portugal":student_math, 
		"International students data": student_int, 
		"Speed dating in Colombia": speed_dating};
		databases = {};
		databases["High school student data in Portugal"] = "math";
		databases["International students data"] = "int";
		databases["Speed dating in Colombia"] = "dating";

		function hasInternet(person){
			return person.internet;
		}
		function hasRomance(person){
			return person.romantic;
		}
		function isHigher(person){
			return person.higher;
		}
		function hasNursery(person){
			return person.nursery;
		}
		function hasActivities(person){
			return person.activities;
		}
		function parentsApart(person){
			return person.Pstatus == "A";
		}
		function liveInCity(person){
			return person.address == "U";
		}

		data_dict["math"] = [hasInternet, hasRomance, isHigher, hasNursery, hasActivities, parentsApart, liveInCity];

		//INTERNATIONAL DATA
		function isMale(person){
			return person.gender;
		}
		function manyAbsences(person){
			return person.StudentAbsenceDays;
		}
		function parentsSatisfied(person){
			return person.ParentschoolSatisfaction;
		}
		function highGrades(person){
			return person.Class == "H";
		}
		function lowGrades(person){
			return person.Class == "L";
		}

		data_dict["int"] = [isMale, manyAbsences, parentsSatisfied, highGrades, lowGrades];

		//SPEEDDATING
		function isMaleDate(person){
			return Number(person.gender);
		}
		function valuesRace(person){
			return Number(person.imprace) >= 6;
		}
		function valuesReligion(person){
			return Number(person.imprelig) >=6;
		}
		function datesFrequently(person){
			//if a person goes on dates more than once a month
			return Number(person.date) <=5;
		}

		data_dict["dating"] = [isMaleDate, valuesRace, valuesReligion, datesFrequently];
		
		var curr_hue = 1;
		d3.select("#user_input").append("text").style("font", "17px times")
		.text("Speed");

		var questions_data_dict = {"math":{
			"Does the student do extracurriculars?": [hasActivities, "Extracurriculars"],
			"Does the student live in urban environment?": [liveInCity, "Urban Area"],
			"Does the student have internet?": [hasInternet, "Internet"],
			"Is the student in a romantic relationship?": [hasRomance, "Romance"],
			"Did the student go to higher education?": [isHigher, "Higer Education"],
			"Did the student go to nursery school?": [hasNursery, "Nursery"],
			"Do the parents live apart?": [parentsApart, "Parents Apart"]
			},

		"int":{
			"Is the student male?": [isMale, "Male"],
			"Does the student have more than 7 absences?": [manyAbsences, "Many absences"],
			"Are the student's parents satisfied with their school?": [parentsSatisfied, "Parents satisfied"],
			"Does the student get high grades?": [highGrades, "High grades"],
			"Does the student get low grades?": [lowGrades, "Low grades"]
		},

		"dating":{
			"Is the subject male?": [isMaleDate, "Male"],
			"Does the participant prefer a partner who is the same race as them?": [valuesRace, "Values same race"],
			"Does the participant prefer a partner who is the same religion as them?": [valuesReligion, "Values same religion"],
			"Does the participant date more than once a month?": [datesFrequently, "Dates more than once a month"]
		}}

		// questions_data = questions_data_dict["math"];

		d3.graphScroll()
			.graph(d3.selectAll('#ball_svg'))
			.container(d3.select('#container'))
		  	.sections(d3.selectAll('#text_for_scroll > div' ))
		  	.on('active', function(i){})


		function add_selector_values(selector_arr, questions){
			//adds values to selectors
			temp_questions = questions;
			selector_arr.forEach(function(selector, questions_ind){
				selector.selectAll("option").remove()
				selector.on("change", function(x){})
					.selectAll("option").data(temp_questions).enter().append("option")
					.text(d=>d)
				selector.select("options").attr("defaultSelected",true);
				var head = temp_questions.shift()
				temp_questions.push(head)
			})
		}

		var selector_1 = d3.select("#selector_1");
		var selector_2 = d3.select("#selector_2");
		var selector_3 = d3.select("#selector_3");
		var select_dataset = d3.select("#dataset");

		var all_selectors = [selector_1, selector_2, selector_3]
		var temp_arr_selectors = [selector_1, selector_2, selector_3];
		var temp_questions_data = questions_data_dict["math"];
		var temp_dataset_questions = databases;
		var temp_dataset_selectors = [select_dataset];
		add_selector_values(temp_arr_selectors, Object.keys(temp_questions_data));
		add_selector_values(temp_dataset_selectors, Object.keys(temp_dataset_questions));
		var created_tree = false;
		var paths;
		
		if (!called_see_tree) see_tree();

		d3.selectAll("#dataset").on("change", ()=>{
			var curr_dataset = select_dataset.property("value")
			var curr_dataset_object = questions_data_dict[databases[curr_dataset]]
			var temp_dataset_selectors = all_selectors;
			var temp_dataset_questions = curr_dataset_object;
			add_selector_values(temp_dataset_selectors, Object.keys(temp_dataset_questions),0);
		});
		see_tree_button = d3.select("#see_tree_button").on("click", see_tree);
		
		function see_tree(e){
			called_see_tree = true;
			factor_obj ={"factor_arr": [], "questions_arr":[], "shortened_arr": []};
			var funct, shorten_q, question;
			var dataset_name = select_dataset.property("value");

			var curr_dataset_object = questions_data_dict[databases[dataset_name]];

			all_selectors.forEach(function(selector){
				question = selector.property("value");
				//console.log("question" + question);
				factor_obj["factor_arr"].push(curr_dataset_object[question][0]);
				factor_obj["questions_arr"].push(question);
				factor_obj["shortened_arr"].push(curr_dataset_object[question][1]);
			})
			tree_root = {"x": ball_svg_width/2, "y": ball_svg_height*.1};

			// var tree_root = {"x": 305, "y": 70};
			var splits = Math.pow(2, factor_obj["factor_arr"].length)
			var normalized_dataset = normalize(find_dataset[dataset_name],factor_obj["factor_arr"]);
			if (created_tree == false){
				tree_arr = createTreeBegin(ball_svg, tree_root, 300, 300, splits);
				paths = createTreePath(ball_svg, tree_arr);

			}
			make_boolean_pies(0, factor_obj["shortened_arr"][0]);
			make_boolean_pies(1, factor_obj["shortened_arr"][1]);
			make_boolean_pies(2, factor_obj["shortened_arr"][2]);

			spoutBalls(ball_svg, ball_svg_height, ball_svg_width, tree_arr, tree_root,normalized_dataset, factor_obj, paths); 		
			addStrings(ball_svg_height, ball_svg_width, tree_arr, ball_svg, factor_obj["questions_arr"]);		
			created_tree = true
			initial_ball_transition(d3.select("#see_tree_button"));
		}

		
 		
 	}	
</script>
</body>