<html>
<head>
<title>Quinn Halpin, qmh4</title>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<style>
	svg { border: solid #ccc 1px; }
	body { font-family: 'Alegreya Sans', Calibri, sans-serif; }
	.words {width : 700px;}
</style>
</head>
<body>
<div>
	<select id = "selector_1">
	</select>
	<select id = "selector_2">
	</select>
	<select id = "selector_3">
	</select>
	<button id="see_tree">See Tree</button>
	<p id = "ball_animation"></p>
</div>
<script type = "text/javascript" src = "animation.js"></script>
<script type="text/javascript">
	var student_math = [];
	var student_por = [];
	var tree_arr = [];
	var paths;
	function parseRow(row) {
		// filter out name of person and entries that have no base pay
		if (Math.round(Number(row.base_pay)) != 0.){
			employee_object = row;
			delete employee_object["employee_name"];
			delete employee_object["notes"];
			employee_object["job_category"] = findCluster(row.job_title);
			return employee_object;
		}
	}

	function parseStudentRow(row) {
		// change all string numbers to numbers
		// yes = 1
		// no = 0
		// some options are not listed here because parsing them wasn't necessary
		row.Dalc = Number(row.Dalc);
		row.Fedu = Number(row.Fedu);
		row.G1 = Number(row.G1);
		row.G2 = Number(row.G2);
		row.G3 = Number(row.G3);
		row.Medu = Number(row.Medu);
		row.Walc = Number(row.Walc);
		row.absences = Number(row.absences);
		row.activities = (row.activities == "yes") ? 1: 0;

		row.age = Number(row.age);
		row.failures = Number(row.failures);
		row.famrel = Number(row.famrel);
		row.famsup = (row.famsup == "yes") ? 1 : 0;
		row.higher = (row.higher == "yes") ? 1: 0;
		row.internet = (row.internet == "yes") ? 1: 0;
		row.nursery = (row.nursery == "yes") ? 1: 0;
		row.romantic = (row.romantic == "yes") ? 1: 0;
		row.schoolsup = (row.schoolsup == "yes") ? 1: 0;
		
		row.freetime = Number(row.freetime);
		row.goout = Number(row.goout);
		row.health = Number(row.health);
		row.studytime = Number(row.studytime);
		row.traveltime = Number(row.traveltime);
		return row;
	}

 	d3.queue()
        .defer(d3.csv, "student_grades/student-mat.csv", parseStudentRow)
        .defer(d3.csv, "student_grades/student-por.csv", parseStudentRow)
        .await(load_data);
    
    function createTreePath(svg, tree_arr){
    	var path_arr = [];
    	var pathGenerator = d3.line()
			.x(function(d){return (d.x)})
			.y(function(d){return (d.y)});	
    	for (var i = 0; i < tree_arr.length; i++){
    		var p = d3.path();
    		p.moveTo(tree_arr[i][0]["x1"],tree_arr[i][0]["y1"])
    		var path_data = [];
    		for (var j = 0; j<tree_arr[i].length-1; j++){
    			p.lineTo( tree_arr[i][j]["x2"], tree_arr[i][j]["y2"]);
    			p.lineTo( tree_arr[i][j+1]["x1"], tree_arr[i][j+1]["y1"]);
    		}
			p.lineTo(tree_arr[i][tree_arr[i].length-1]["x2"], tree_arr[i][tree_arr[i].length-1]["y2"]);
    		p = p.toString();
    		svg_path= svg.append("path").attr("d", p).style("stroke-width", 2)
    		.attr("id", "path_" + i)
            .style("stroke", "steelblue")
            .style("stroke-width", "5px")
            .style("fill", "none")
            .style("opacity", 0);

            path_arr.push(svg_path);
    	}
    	return path_arr;
    }	

 	function load_data(error, math, portugal){
 		student_math = math;
 		student_por = portugal;
 		var ball_svg_height = 900;
		var ball_svg_width = 1000;
		
		var ball_svg = d3.select("#ball_animation").append("svg")
		.attr("height", ball_svg_height)
		.attr("width", ball_svg_width);

		function hasInternet(person){
			return person.internet;
		}
		function hasRomance(person){
			return person.romantic;
		}
		function isHigher(person){
			return person.higher;
		}
		function hasNursery(person){
			return person.nursery;
		}
		function hasActivites(person){
			return person.activities;
		}
		function parentsApart(person){
			return person.Pstatus == "A";
		}
		function liveInCity(person){
			return person.Pstatus == "U";
		}
		
		var curr_hue = 1;
		d3.select("#see_grades").on("click", function() {see_grades(ball_svg)});
		d3.select("#user_input").append("text").style("font", "17px times")
		.text("Speed");

		var questions_data = {
			"Does the student do extracurriculars?": [hasActivites, "Extracurriculars"],
			"Does the student live in urban environment?": [liveInCity, "Urban Area"],
			"Does the student have internet?": [hasInternet, "Internet"],
			"Is the student in a romantic relationship": [hasRomance, "Romance"],
			"Did the student go to higher education?": [isHigher, "Higer Education"],
			"Did the student go to nursery school?": [hasNursery, "Nursery"],
			"Do the parents live apart?": [parentsApart, "Parents Apart"]
			}


		function add_selector_values(selector_arr, questions, questions_ind){
			if (selector_arr.length <=0) return;
			var selector = selector_arr[0]
			selector.on("change", function(x){console.log(d3.select(this).property("value"))})
				.selectAll("option").data(questions).enter().append("option")
				.text(d=>d)
			selector.select("options").attr("defaultSelected",true);
			var head = questions.shift()
			questions.push(head)
			selector_arr.shift()
			add_selector_values(selector_arr, questions, questions_ind + 1)

			// selector_arr.forEach(function(selector,i){
			// 	selector.on("change", function(x){console.log(d3.select(this).property("value"))})
			// 	.selectAll("option").data(questions).enter().append("option")
			// 	.text(d=>d)
				
				
			// })
		}

		var selector_1 = d3.select("#selector_1")
		var selector_2 = d3.select("#selector_2")
		var selector_3 = d3.select("#selector_3")
		var all_selectors = [selector_1, selector_2, selector_3]
		var temp_arr_selectors = [selector_1, selector_2, selector_3];
		var temp_questions_data = questions_data;
		add_selector_values(temp_arr_selectors, Object.keys(temp_questions_data), 0)

		d3.select("#see_tree").on("click", see_tree);
		var created_tree = false;
		var paths;
		function see_tree(){
			factor_obj ={"factor_arr": [], "questions_arr":[], "shortened_arr": []};
			var funct, shorten_q, question;
			all_selectors.forEach(function(selector){
				console.log(selector.property("value"))
				question = selector.property("value");
				factor_obj["factor_arr"].push(questions_data[question][0]);
				factor_obj["questions_arr"].push(question);
				factor_obj["shortened_arr"].push(questions_data[question][1]);
			})
			var tree_root = {"x": 205, "y": 70};
			var splits = Math.pow(2,factor_obj["factor_arr"].length)
			console.log(factor_obj)
			if (created_tree == false){

				tree_arr = createTreeBegin(ball_svg, tree_root, 200, 200, splits);
				paths = createTreePath(ball_svg, tree_arr);
			}
			spoutBalls(ball_svg, ball_svg_height, ball_svg_width, tree_arr, tree_root,student_math, factor_obj, paths);
 			addStrings(ball_svg_height, ball_svg_width, tree_arr, ball_svg, factor_obj["questions_arr"]);		
			created_tree = true;
		}

		
 		
 	}	
</script>
</body>